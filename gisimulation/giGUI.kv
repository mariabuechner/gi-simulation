#:kivy 1.10.0
#:import np numpy
#:import ntpath ntpath
#:import parser_def simulation.parser_def
#:import test kivy_test

#:set parser_info parser_def.get_arguments_info(parser_def.input_parser())
#:set num_input_size 0.3
#:set default_font_size 18
#:set line_height 40
#:set menu_button_width 100
#:set dark_grey np.divide([88, 88, 88, 50],[255., 255., 255., 100.])
#:set dark_red_button np.divide([255, 50, 50, 100],[255., 255., 255., 100.])
#:set dark_red_menu np.divide([154, 31, 31, 100],[255., 255., 255., 100.])


# All buttons
<Button>:
    font_size: default_font_size
    text_size: self.size
    halign: 'center'
    valign: 'center'
    max_lines: 1
    size_hint_y: None
    height: line_height

# All text inputs
<TextInput>:
    size_hint_y: None
    height: line_height
    size_hint_x: num_input_size
    multiline: False

# All checkboxes
<CheckBox>:
    size_hint: (None, None)
    height: line_height
    width: line_height
    canvas.before:
        Color:
            rgba: dark_grey
        Rectangle:
            pos: self.pos
            size: self.size


# All BoxLayouts
<BoxLayout>:
    padding: (1, 1, 0, 0 )

# All StaackLayouts
<StackLayout>:
    padding: (1, 1, 0, 0 )

# Set rules for custom classes

# All NonFileBrowserLabel
<NonFileBrowserLabel>:
    font_size: default_font_size
    text_size: self.size
    halign: 'center'
    valign: 'center'
    max_lines: 1
    size_hint_y: None
    height: line_height
    canvas.before:
        Color:
            rgba: dark_grey
        Rectangle:
            pos: self.pos
            size: self.size


<MenuSpinnerButton>:
    background_color: dark_red_button
    halign: 'left'

<ScrollableLabel>:
    NonFileBrowserLabel:
        font_size: default_font_size
        max_lines: 0
        size_hint_y: None
        height: self.texture_size[1]
        text_size: self.width, None
        text: root.text
        halign: 'left'
        valign: 'top'
        strip: True  #remove leading or trailing newlines or spaces

# gi GUI
<giGUI>:
    orientation: 'vertical'
    color:

    # Main Menu
    BoxLayout:
        size_hint_y: None
        height: line_height
        canvas.before:
            Color:
                rgba: dark_red_menu
            Rectangle:
                pos: self.pos
                size: self.size
        NonFileBrowserLabel:
            size_hint_x: 0.1
            bold: True
            text: 'GI Simulation'
            canvas.before:
                Color:
                    rgba: dark_red_menu
                Rectangle:
                    pos: self.pos
                    size: self.size
        Button:
            size_hint_x: 0.1
            background_color: dark_red_button
            text: 'Load input file...'
            on_release: root.show_input_load()
        MenuSpinner:
            size_hint_x: 0.1
            background_color: dark_red_button
            id: save_spinner
            text: 'Save...'
            values: ['Input file...', 'Results...']
            on_text: root.on_save_spinner(self)
        Widget:

        MenuSpinner:
            size_hint_x: 0.1
            background_color: dark_red_button
            id: help_spinner
            text: 'Help...'
            values: ['Spectrum file', 'Input file']
            on_text: root.on_help_spinner(self)
        Button:
            background_color: dark_red_button
            size_hint_x: 0.05
            text: 'Exit'
            on_release: root.exit_app()


    # Splitter to seperate general input area (left) and Tabs for results
    # and specific input (right)
    BoxLayout:
        Splitter:
            sizable_from: 'right'
            max_size: root.width*0.9
            min_size: root.width*0.02



            # Right side of splitter
            # Content of 'general input window'
            BoxLayout:
                orientation: 'vertical'

                # Name of window
                NonFileBrowserLabel:
                    text: 'General Parameters'
                    bold: True

                # General input
                GridLayout:
                    cols: 3
                    StackLayout:
                        NonFileBrowserLabel:
                            text: 'Spectrum'
                            bold: True
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: root.calc_boxlayout_height(line_height, self)
                            BoxLayout:
                                LabelHelp:
                                    text: 'Design Energy [keV]'
                                    help_message: parser_info['design_energy'][1]
                                FloatInput:
                                    id: design_energy
                            BoxLayout:
                                LabelHelp:
                                    size_hint_x: 0.4
                                    text: 'Choose spectrum file'
                                    help_message: "Location of spectrum file (.csv).\nFile format:\nenergy,photons\ne1,p1\ne2,p2\n.,.\n.,.\n.,."
                                Button:
                                    size_hint_x: 0.1
                                    text: 'Load'
                                    on_press: root.show_spectrum_load()
                                Button:
                                    size_hint_x: 0.15
                                    text: 'Remove'
                                    on_press: root.spectrum_file_path = ''
                                TextInput:
                                    text: ntpath.basename(root.spectrum_file_path)
                            BoxLayout:
                                LabelHelp:
                                    text: 'Spectrum range [keV]'
                                    help_message: parser_info['spectrum_range'][1]
                                CheckBox:
                                    id: spectrum_range_set
                            BoxLayout:
                                BoxLayout:
                                    size_hint_x: 0.5
                                    NonFileBrowserLabel:
                                        text: 'Min'
                                    FloatInput:
                                        id: spectrum_range_min
                                        size_hint_x: 1
                                        disabled: not spectrum_range_set.active
                                BoxLayout:
                                    size_hint_x: 0.5
                                    NonFileBrowserLabel:
                                        text: 'Max'
                                    FloatInput:
                                        id: spectrum_range_max
                                        size_hint_x: 1
                                        disabled: not spectrum_range_set.active
                            BoxLayout:
                                LabelHelp:
                                    text: 'Spectrum step size [keV]'
                                    help_message:parser_info['spectrum_step'][1]
                                FloatInput:
                                    id: spectrum_step
                                    text: '1.0'
                                    disabled: not spectrum_range_set.active or root.spectrum_file_loaded

                    # GI input
                    StackLayout:
                        NonFileBrowserLabel:
                            text: 'GI Input'
                            bold: True
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: root.calc_boxlayout_height(line_height, self)
                            BoxLayout:
                                LabelHelp:
                                    text: 'Geometry'
                                    help_message: parser_info['geometry'][1]
                                Spinner:
                                    id: geometry
                                    text: 'sym'
                                    values: ['sym', 'conv', 'inv', 'free']


                    StackLayout:
                        NonFileBrowserLabel:
                            text: '3. block'
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: root.calc_boxlayout_height(line_height, self)
                            Button:
                            Button:
                            Button:


                # Grating input
                GridLayout:
                    cols: 3
                    StackLayout:
                        BoxLayout:
                            NonFileBrowserLabel:
                                text: 'G0'
                                bold: True
                            CheckBox:
                                id: g0_set
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: root.calc_boxlayout_height(line_height, self)
                            disabled: not g0_set.active
                            BoxLayout:
                                LabelHelp:
                                    text: 'Design Energy [keV]'
                                    help_message: parser_info['design_energy'][1]
                                FloatInput:
                            BoxLayout:
                                LabelHelp:
                                    size_hint_x: 0.4
                                    text: 'Choose spectrum file'
                                    help_message: "Location of spectrum file (.csv).\nFile format:\nenergy,photons\ne1,p1\ne2,p2\n.,.\n.,.\n.,."
                                Button:
                                    size_hint_x: 0.1
                                    text: 'Load'
                                    on_press: root.show_spectrum_load()
                                Button:
                                    size_hint_x: 0.15
                                    text: 'Remove'
                                    on_press: root.spectrum_file_path = ''
                                TextInput:
                                    text: ntpath.basename(root.spectrum_file_path)
                            BoxLayout:
                                LabelHelp:
                                    text: 'Spectrum range [keV]'
                                    help_message: parser_info['spectrum_range'][1]
                                CheckBox:
                            BoxLayout:
                                BoxLayout:
                                    size_hint_x: 0.5
                                    NonFileBrowserLabel:
                                        text: 'Min'
                                    FloatInput:
                                        size_hint_x: 1
                                        disabled: not spectrum_range_set.active
                                BoxLayout:
                                    size_hint_x: 0.5
                                    NonFileBrowserLabel:
                                        text: 'Max'
                                    FloatInput:
                                        size_hint_x: 1
                                        disabled: not spectrum_range_set.active
                            BoxLayout:
                                LabelHelp:
                                    text: 'Spectrum step size [keV]'
                                    help_message:parser_info['spectrum_step'][1]
                                FloatInput:
                                    text: '1.0'
                                    disabled: not spectrum_range_set.active or root.spectrum_file_loaded


                    # GI input
                    StackLayout:
                        BoxLayout:
                            NonFileBrowserLabel:
                                text: 'G1'
                                bold: True
                            CheckBox:
                                id: g1_set
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: root.calc_boxlayout_height(line_height, self)
                            disabled: not g1_set.active
                            BoxLayout:
                                LabelHelp:
                                    text: 'Geometry'
                                    help_message: parser_info['geometry'][1]
                                Spinner:
                                    text: 'sym'
                                    values: ['sym', 'conv', 'inv', 'free']


                    StackLayout:
                        BoxLayout:
                            NonFileBrowserLabel:
                                text: 'G2'
                                bold: True
                            CheckBox:
                                id: g2_set
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: root.calc_boxlayout_height(line_height, self)
                            disabled: not g2_set.active
                            Button:
                            Button:
                            Button:

                Widget:
                Widget:
                Widget:

                Button:
                    text: 'Check input'
                    on_press: root.check_general_input()




        # Left side of splitter
        TabbedPanel:
            do_default_tab: False

            # Geometry
            TabbedPanelItem:
                text: 'Geometry'
                NonFileBrowserLabel:
                    text: '1. tab content area'

            # Visibility
            TabbedPanelItem:
                text: 'Visibility'
                NonFileBrowserLabel:
                    text: '2. tab content area'

            # CT
            TabbedPanelItem:
                text: 'CT'
                BoxLayout:
                    NonFileBrowserLabel:
                        text: 'bla'
                    Button:
                        text: 'Raise error and display'
                        on_press: root.check_general_input()